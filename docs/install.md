# Установка локальной версии

В первую очередь, нужны:

1. nginx
2. nodejs
3. npm
4. mongodb

## Веб-сервер

Nginx проксирует запросы к node-серверу и отдаёт статику.

Конфиг лежит в репозитории, [nginx.conf](../nginx.conf). Чтобы он заработал, надо:

1. сделать каталог `vhosts` рядом с основным nginx-конфигом (или использовать стандартные `sites-enabled` и `sites-available`), а в нём симлинк на `nginx.conf` проекта;
1. добавить в основной конфиг `include vhosts/*.conf`; в конец раздела `http`;
1. сделать симлинк `ithank` из каталога, в который установлен nginx, на каталог с проектом, чтобы [заработали относительные пути в конфиге](http://serverfault.com/a/548332);
1. перезапустить сервер.

В дев-конфиге полностью отключён кеш, а сервер отзывается на адрес `ithank.local`. Чтобы он начал резолвиться, в `/etc/hosts` надо добавить `127.0.0.1 ithank.local`.

## Установка зависимостей

Фронденд сайта собирает `gulp`, его имеет смысл ставить глобально.

```bash
$ sudo npm i -g gulp
```

Так же должна быть установлена [mongodb](http://www.mongodb.org/) версии `2.0.6` и добавлено `mongod` в переменную окружения, чтобы работало:

```bash
$ mongod
```

Кроме того, должны быть соответствующие права на запись для каталога `/data/db/`

Для установки зависимостей достаточно выполнить в корне проекта

```bash
$ npm i
```

## Сборка фронтенда

```bash
$ gulp
```

С некоторых пор собранные файлы, лежащие в `static/`, исключены из репозитория.
Для упрощения жизни можно сделать `post-merge` хук

```bash
touch .git/hooks/post-merge
chmod +x .git/hooks/post-merge
```

и добавить в него сборку:

```bash
#!/bin/bash
gulp
```

## Запуск и остановка приложения
Для управления приложением можно пользоваться `npm run-script`. Доступны следующий команды из корня проекта:

1. `npm start` запускает монгу и запускает *или* перезапускает приложение;
2. `npm stop` останавливает всё.

Так уж вышло, что в дев-режиме мы валим весь вывод в консоль, но запускаем приложение в фоне. 

## Проверочные данные

На деве мы используем базу `ithank_dev`. Данные для первоначального наполнения лежат в `tests/mocks/`. Привести дев-базу к исходному виду поможет скрипт `test/reset-db`.

**Внимание!** Скрипт дропает коллекцию `thanks`.
